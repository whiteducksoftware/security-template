# Runs the Snyk container scanning workflow reguraly on the main branch and publishes the results to GitHub Security.
name: Snyk Container

on:
  schedule:
    - cron: '0 0 * * 0'

permissions:
  contents: read

jobs:
  snyk:
    runs-on: ubuntu-latest
  
    permissions:
      contents: read
      security-events: write
      
    strategy:
      matrix:
        project:
          - name: API
            path: src/DemoAPI
            image: demoapi
          - name: Web
            path: src/DemoFrontend
            imasge: demofrontend
      
    steps:
      - name: 'Checkout Repository'
        uses: actions/checkout@v3

      - name: 'Build the Container image'
        run: |
          echo "Building the container image for ${{ matrix.project.name }}..."
          docker build -t ${{ matrix.project.image }} -f ${{ matrix.project.path }}/Dockerfile ${{ matrix.project.path }} 

      - name: 'Run Snyk to check Docker image for vulnerabilities'
        # Snyk can be used to break the build when it detects vulnerabilities.
        # In this case we want to upload the issues to GitHub Code Scanning
        continue-on-error: true
        uses: snyk/actions/docker@master
        env:
          # In order to use the Snyk Action you will need to have a Snyk API token.
          # More details in https://github.com/snyk/actions#getting-your-snyk-token
          # or you can signup for free at https://snyk.io/login
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          image: ${{ matrix.project.image }}
          args: --file=${{ matrix.project.path }}/Dockerfile

      - name: Upload result to GitHub Code Scanning
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: snyk.sarif